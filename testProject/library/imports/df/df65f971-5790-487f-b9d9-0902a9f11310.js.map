{"version":3,"sources":["../../../../assets/Scripts/assets/Scripts/FbInstantGames.js"],"names":["cc","Class","extends","Component","properties","testText","Label","shareUrl","String","start","shareGame","console","log","FBInstant","shareAsync","intent","image","getImgBase64","text","data","myReplayData","then","string","sendRequest","catch","playMessage","updateAsync","action","cta","default","player","getName","localizations","en_US","pt_BR","id_ID","fr_CA","vi_VN","th_TH","tr_TR","de_DE","es_ES","ar_AE","ja_JP","template","strategy","notification","createShortCut","canCreateShortcutAsync","canCreateShortcut","createShortcutAsync","PlayWithFriends","context","chooseAsync","e","onBuyBot","subscribeBotAsync","target","find","width","height","renderTexture","RenderTexture","begin","_sgNode","visit","end","canvas","document","createElement","ctx","getContext","_renderType","game","RENDER_TYPE_CANVAS","texture","getSprite","getTexture","getHtmlElementObj","drawImage","RENDER_TYPE_WEBGL","buffer","gl","createFramebuffer","bindFramebuffer","FRAMEBUFFER","_glID","framebufferTexture2D","COLOR_ATTACHMENT0","TEXTURE_2D","Uint8Array","readPixels","RGBA","UNSIGNED_BYTE","rowBytes","row","srow","data2","Uint8ClampedArray","imageData","ImageData","putImageData","toDataURL","showSC"],"mappings":"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","file":"FbInstantGames.js","sourceRoot":"../../../../assets/Scripts","sourcesContent":["\n//\n//      各関数のimage要素を指定した画像にしたい場合、あらかじめBase64に変換した文字列型を入力してください。ただ、すごく長いです。\n//      画像が小さすぎると最低ラインまで引き伸ばして表示されるので注意。200px未満は若干ぼやけるようです。\n//      48:25の画像だとスマホでジャストのサイズになります。(PC版だとフルで表示されます)720x375が理想サイズ。\n//      スクショでいいならgetImgBase64()を読んだだけで大丈夫です。\n//\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        testText: cc.Label,\n        shareUrl: String,\n    },\n\n    // onLoad () {},\n\n    start() {\n        this.shareUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAC4jAAAuIwF4pT92AAAAB3RJTUUH4wUHByotJsjynQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAALiSURBVFjD7Zg7aCpREIaPl9tY2AYEK4sUFiliYyMEwWKxCaSxU4SkTGsn2IhgYROIVqIgixKDBBNiIxgUBWVBTLZYiAYDiahY+Ejwsc6tcrkX58THriZFBk5zzgz/tz/rcWYVAADkG8cv8s3jB/DLAWOxGFEoFOg6PDwk0+lUmgBIiOFwCPv7+0AIoa5SqSRFAiQ5mMvlCMdxn+ZEIpGvcXAymYDFYvnUvY8lCML2HSyXy+T6+nqp3MvLy+06OJvN4Pj4GHXr4OAA3X99fV3LwbUAHx4eUAir1Qocx6FnoVBoe4AulwuFyGQyMJ1O4ejoaO5Mq9VCr9fbPODT0xMKt7e3B29vbwAAkE6n0ZxUKrV5wLOzM1Q8Go3+zen1eqDRaOZyTCYTjEajzQF2Oh1QqVQoYLPZ/C83GAyiefl8fnOALMuioh6PZy63Xq+juQ6HA2azmfyAg8EAdDodKsrzPFpzenqK5t/f38sPeHNzg4rZ7XaqI4VCAa1xuVzyAo7HY2AYBhW7u7uj1o1GIzAajWhdo9GQDzCfz6MiBoMB3t/fP629uLhAa8/Pz+UBFEURHA4HKhKPxxcKtNtttHZnZwe63a50wGq1Su1SOp3OUi54vV60PpFILKz9vaiZYFkW3ddoNMTj8SzVkNTrdXTf5/MRhmGIUqlcr5uh3WVyrkwms34/eHV1tfGhKBAIEFEUV3eQ9nJvYnEct7qD6XR6a6NlNBpdzcF+vw+7u7tbc5AQAo+Pj8s7mM1miSAIWx3Qqe879vdkNpvRp2RZFqRGIBCguthqtRZf1LlcTtLNvyien5+pgP82vSigKIpgs9lkHXqwcLvdqIZOp4PBYEAHrFQqaKFKpULtXzd4nqe6eHt7Swd0Op2SOo9V5uqTkxNUy2KxwGQymQes1WrUp3p5eQG5g9bMEkKgWCzOXzPJZBL9lfv9fqJWq2W/VvR6PWEYBj0Lh8Pk48u04ucb9Q/gF8cfVFprgBwHlgUAAAAASUVORK5CYII=';\n    },\n\n    //シェア機能。現状はタイムライン投稿しようとするとtextメッセージが消えてしまう。\n    shareGame() {\n\n        console.log('シェア');\n\n        if (typeof FBInstant == 'undefined')\n            return;\n\n        FBInstant.shareAsync({\n            intent: 'SHARE',    //何をするのか\n            // image: cc.RawAsset.rawUrl,    //シェアするときの画像\n            // image: this.pic.url,\n            image: this.getImgBase64(),\n            text: 'Great!',\n            data: { myReplayData: '...' },\n        }).then(() => {\n            // continue with the game.\n            this.testText.string = '共有完了';\n            console.log('共有完了');\n        });\n\n    },\n\n    //アプリへの招待\n    sendRequest() {\n\n        console.log('招待');\n\n        if (typeof FBInstant == 'undefined')\n            return;\n\n        FBInstant.shareAsync({\n            intent: 'CUSTOM',\n            image: this.getImgBase64(),\n            text: '',\n            data: { myReplayData: '...' },\n        }).then(function () {\n            this.testText.string = 'Message was sent successfully';\n            console.log('Message was sent successfully');\n        }).catch(function () {\n            this.testText.string = '';\n            console.log('failed!');\n        });\n\n    },\n\n    //友達とのチャット画面でゲームを始めた時にだけ呼ばれる。「〇〇さんが今プレイしました。次はあなたの番です」←これ\n    playMessage() {\n        console.log('プレイ状況通知');\n\n        if (typeof FBInstant == 'undefined')\n            return;\n\n        FBInstant.updateAsync({\n            action: 'CUSTOM',\n            cta: 'Play',\n            // image: this.getImgBase64(),\n            image: this.shareUrl,\n\n            //言語別で表示するメッセージを変える。言語コードについては→　　https://so-zou.jp/web-app/tech/data/code/language.htm\n\n            text:\n            {\n                default: FBInstant.player.getName() + \"just played. It's your turn!\",\n                localizations: {\n                    //派生言語は別に追加する必要あり。\n                    en_US: '',                                                                  //英語(アメリカ)\n                    pt_BR: '',                                                                  //ポルトガル語(ブラジル)\n                    id_ID: '',                                                                  //インドネシア語(インドネシア)\n                    fr_CA: '',                                                                  //フランス語(フランス)\n                    vi_VN: '',                                                                  //ベトナム語(ベトナム)\n                    th_TH: '',                                                                  //タイ語(タイ)\n                    tr_TR: '',                                                                  //トルコ語(トルコ)\n                    de_DE: '',                                                                  //ドイツ語(ドイツ)\n                    es_ES: '',                                                                  //スペイン語(スペイン)\n                    ar_AE: '',                                                                  //アラビア語(アメリカ)\n\n                    ja_JP: FBInstant.player.getName() + 'さんが今プレイしました。あなたの番です！',     //日本語(日本)\n                }\n            },\n            template: 'WORD_PLAYED',\n            data: { myReplayData: '...' },\n            strategy: 'IMMEDIATE',\n            notification: 'NO_PUSH',\n        }).then(function () {\n            console.log('Message was sent successfully');\n            this.testText.string = 'Message was sent successfully';\n        }).catch(function () {\n            console.log('failed!');\n            this.testText.string = 'failed';\n        });\n\n    },\n\n    //ショートカット作成(Androidのみ対応)\n    createShortCut() {\n\n        console.log('ショートカット作成');\n        if (typeof FBInstant == 'undefined')\n            return;\n\n        FBInstant.canCreateShortcutAsync()\n            .then(function (canCreateShortcut) {\n                if (canCreateShortcut) {\n                    FBInstant.createShortcutAsync()\n                        .then(function () {\n                            // Shortcut created\n                            this.testText.string = 'ショートカット作成';\n                        })\n                        .catch(function () {\n                            // Shortcut not created\n                            this.testText.string = 'ショートカット作成失敗';\n                        });\n                }\n            });\n    },\n\n    //友達を選択して一緒に遊ぶ。ゲームを終了しないで処理が行える。\n    PlayWithFriends() {\n\n        console.log('一緒にプレイ');\n\n        if (typeof FBInstant == 'undefined')\n            return;\n\n        FBInstant.context.chooseAsync().then(function (e) {\n\n            this.testText.string = \"FBInstant.context.chooseAsync complete\";\n            console.log(\"FBInstant.context.chooseAsync complete\");\n            console.log(e);\n        });\n    },\n\n    //Botサイト登録。\n    onBuyBot() {\n        FBInstant.player.subscribeBotAsync().then({\n            // Player is subscribed to the bot\n        }).then(function (e) {\n            console.log('Bot購読済み');\n            this.testText.string = 'Bot購読済み';\n        }).catch(function (e) {\n            // Handle subscription failure\n            this.testText.string = 'Bot未購読';\n        });\n    },\n\n    //呼ばれたタイミングでスクショを撮る。シェアなどのimageにはここの戻り値を入れればいいかも\n    getImgBase64() {\n        let target = cc.find('Canvas');\n        // let width = cc.winSize.width, height = cc.winSize.height;\n        let width = 720, height = 375;\n        let renderTexture = new cc.RenderTexture(width, height);\n        renderTexture.begin();\n        target._sgNode.visit();\n        renderTexture.end();\n        //\n        let canvas = document.createElement('canvas');      //HTML要素生成。\n        let ctx = canvas.getContext('2d');\n        canvas.width = width;                               //\n        canvas.height = height;                             //縦横幅設定\n        if (cc._renderType === cc.game.RENDER_TYPE_CANVAS) {\n            let texture = renderTexture.getSprite().getTexture();\n            let image = texture.getHtmlElementObj();\n            ctx.drawImage(image, width / 2, height / 2);\n            console.log('renderType:canvas');\n        }\n        else if (cc._renderType === cc.game.RENDER_TYPE_WEBGL) {\n            let buffer = gl.createFramebuffer();\n            gl.bindFramebuffer(gl.FRAMEBUFFER, buffer);\n            let texture = renderTexture.getSprite().getTexture()._glID;\n            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\n            let data = new Uint8Array(width * height * 4);\n            gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, data);\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n            let rowBytes = width * 4;\n            for (let row = 0; row < height; row++) {\n                let srow = height - 1 - row;\n                let data2 = new Uint8ClampedArray(data.buffer, srow * width * 4, rowBytes);\n                let imageData = new ImageData(data2, width, 1);\n                ctx.putImageData(imageData, 0, row);\n            }\n            console.log('renderType:WebGL');\n        }\n        return canvas.toDataURL('image/png');\n    },\n\n    showSC() {\n        console.log(this.getImgBase64());\n    }\n\n    // update (dt) {},\n});\n"]}